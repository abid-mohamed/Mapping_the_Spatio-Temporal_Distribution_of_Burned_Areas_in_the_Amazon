---
title: "Preparation_Amazon_data"
date: "2022-12-28"
output:
  html_document: 
    number_sections: yes
    fig_caption: yes
    toc: true
    toc_float: 
      collapsed: true
    theme: cerulean
    highlight: kate
    toc_depth: 5
    keep_md: yes
    df_print: paged
---

# Load libraries

```{r, load libraries}
# load libraries
library(tictoc)
library(tidyverse)
library(terra)
library(sf)
library(RColorBrewer)
library(rts)
library(doParallel)
library(parallel)
library(foreach)
library(data.table)
path.png <- "~/Documents/png/"
path.csv <- "~/Documents/csv/"
path.data <- "~/Documents/Amazon_new_data/"
nbrCores <- 30
options(max.print=5000)
```

# Functions

```{r "Functions"}
# Function to save layers
saveLayers = function(dataRast, shapeFile, pathFile, strRemove,
                      x_min=xmin(dataRast), x_max=xmax(dataRast), 
                      y_min=ymin(dataRast), y_max=ymax(dataRast)){
  
  # Iterate all the layers
  for (i in 1:nlyr(dataRast)){
    print(i)
    dataRast.i <- dataRast[[i]]
    # Crop data
    dataRast.basin.i <- mask(dataRast.i, mask = shapeFile) %>%
      crop(ext(x_min, x_max, y_min, y_max))
    # Path of the file
    path <- gsub(strRemove, "", names(dataRast.basin.i)) %>%
      paste0(pathFile, ., ".tif")
    # Save file
    writeRaster(dataRast.basin.i, path, overwrite=TRUE)
    # Clear memory
    gc()
  }
}

# Function to rename layers
renameLayers <- function(dataRast, fileStart, prefix){
  # index of file name in the path
  id.date <- unlist(gregexpr(fileStart, sources(dataRast)[[1]])) + nchar(fileStart)
  # rename layers
  names(dataRast) <- 
    substr(sources(dataRast), id.date, (id.date+50)) %>%
    gsub(".tif", "_1", .) %>%
    as.Date("%Y_%m_%d") %>%
    format(., '%Y_%m') %>%
    paste0(prefix, .)
  
  return(dataRast)
}
```

# Load data

```{r}
my.path <- "~/Documents/"
load(paste0(my.path,"R_data/data-amaz_na3.RData"))
```

#=====================

# Import shape file

```{r}
# Import shape file
amaz.basin.shp <- st_read(paste0(path.data,"0. Amazon_shapefile/projected/amazon_shp_projected.shp"))
```

#=====================

# Burnt Area data

## Import data

```{r "1.1.Import data"}
# list of files
amaz.burntArea.list <- list.files(paste0(path.data,"1. Burnt Area/03. Working Data"),
                                  full.names=TRUE,
                                  pattern = ".tif$")
# Import data with "Terra"
burntArea.rast <- rast(amaz.burntArea.list)
burntArea.rast
```

## Verification of the data

### Names of layers

```{r "1.2.Names of layers"}
names(burntArea.rast) %>% head()
```

### Find duplicate name layers

```{r "1.3.Find duplicate layers"}
idx.dplc <- names(burntArea.rast) %>% duplicated() %>% which()
idx.dplc
```

### Print duplicate name layers

```{r "1.4.Print duplicate layers"}
burntArea.rast[[names(burntArea.rast) == names(burntArea.rast)[idx.dplc]]]
```

### Verification of the values

```{r "1.5.Verification of the values"}
# Verification of the values
burntArea.minmax <- minmax(burntArea.rast) %>% t() %>% as.data.frame()
burntArea.minmax
burntArea.minmax[which((burntArea.minmax[,1] != -2) & (burntArea.minmax[,2] != 1)),]
```

### Plot of the months September and November 2012

```{r "1.6.plot"}
# Create palette of color
pal <- colorRampPalette(c("lightblue", "forestgreen", "firebrick"))
# burntArea.freq <- freq(burntArea.rast, digits=0, usenames=T)
burntArea.freq[(burntArea.freq[,2] != -2)&(burntArea.freq[,2] != 0)&(burntArea.freq[,2] != 1),]
plot(burntArea.rast[[c(142,144)]], col=pal(3))
```

## Modification of the data: Rename layers

### Rename layers

```{r "1.7.Rename_layers"}
# Rename layers
burntArea.rast <- renameLayers(burntArea.rast, 'burntarea_working_', 'fire_')
# Order layers
ordered.names.1 <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month") %>% 
  format(., '%Y_%m') %>%
  paste0("fire_", .)
burntArea.rast <- burntArea.rast[[ordered.names.1]]
burntArea.rast
```

### Create 'rts' object

```{r "1.7.rts"}
# Create a sequence date for 'rts' object
seq.dates <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month")
burntArea.rts <- rts(burntArea.rast, seq.dates)
burntArea.rts
```

## Plot

### Define palette of color

```{r "1.8.plot"}
# Create palette of color
pal <- colorRampPalette(c("lightblue", "forestgreen", "firebrick"))
pal2 <- colorRampPalette(c("forestgreen", "firebrick"))
```

### Plot all the area

```{r "1.9.plot", warning=FALSE}
# Plot Amazon in the year 2012.
burntArea.rts[['2012']]@raster %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(., col=pal(3))

# plot Amazon in October 2020.
plot(burntArea.rts[['2020-10-01']], col=pal(3), main="Burnt area in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
burntArea.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=pal(3), main="Burnt area in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot south of Amazon

```{r "1.10.plot", warning=FALSE}
x_min=-1.25e+06; x_max=0.05e+06; y_min=ymin(burntArea.rast); y_max=2.4e+06

# Plot south of Amazon in the year 2020.
burntArea.rts[['2020']]@raster %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=pal(3))

# Plot south of Amazon in October 2020.
burntArea.rts[['2020-10-01']] %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=pal(3), main="Burnt area in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot of all years

```{r}
# Plot Amazon in the year 2012.

# doParallel::registerDoParallel(cores=20)
# dtlist <- 
#   foreach (i=2001:2020, 
#            .packages=c('terra'), 
#            .combine='c') %dopar% 
#   {
#     y <- as.character(i)
#     png(filename=paste0(path.png, "burntArea_", y, ".png"), width = (400*6), height = (400*3), units = "px")
#     burntArea.rts[[y]]@raster %>% 
#       mask(mask = amaz.basin.shp) %>% 
#       plot(., col=pal(3), cex = 2)
#     dev.off()
#   }

for (i in 2001:2020){
  cat(i)
  y <- as.character(i)
  par(mfrow=c(3, 4))
  p <- burntArea.rts[[y]]@raster %>% mask(mask = amaz.basin.shp) 
  png(filename=paste0(path.png, "burntArea_", y, ".png"), width = (400*6), height = (400*3), units = "px")
  plot(p, col=pal(3), cex = 1.5)
  dev.off()
}
```



## Repalce undifined values by `NA`

```{r "1.11.na"}
burntArea.rast[[c(139, 141)]][burntArea.rast[[c(139, 141)]] == -1] <- NA
burntArea.rast[[c(139, 141)]]
```

## Verification of the `NA` values

```{r "1.12.na"}
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl, cores=detectCores() - 1)

tic("burntArea")
#Raster to datatable in parallel: one raster per thread
rasList <- foreach (ras_id=amaz.burntArea.list, .packages=c('terra', 'sf'), .combine='c') %dopar% {
  #Read all rasters into one big stack
  ras <- rast(paste0(my.path,ras_id))
  # Rename layers
  ras <- renameLayers(ras, 'burntarea_working_', '')
  # Replace negative value by `NA`
  if (names(ras) %in% c("2012_07", "2012_09")) {ras[ras == -1] <- NA}
  #
  ras.nonNA <- not.na(ras)
  ras.nonNA.mask <- mask(ras.nonNA, amaz.basin.shp)
  ras.freq.na <- freq(ras.nonNA.mask, digits=0, value=0, usenames=T)

  list(ras.freq.na)
}
stopCluster(cl)
toc()

#Bind all per-raster into one dataframe
burntArea.freq.na <- rbindlist(rasList, fill=T, use.names=T)
#
colnames(burntArea.freq.na)[3] <- "burntArea_na"
burntArea.freq.na <- burntArea.freq.na[order(burntArea.freq.na$layer)]
burntArea.freq.na
```

##---

## Burnt Area 

```{r}
q <- terra::quantile(burntArea.rast)
plot(q[[5]])
q1 <- mask(q[[5]], amaz.basin.shp)
names(q1) <-"burntArea"
plot(q1, col=pal(3))
# writeRaster(q1, paste0(path.data,"1. Burnt Area/q1.tif"), overwrite=TRUE)
```

```{r}
library(raster)
ras0 <- q1 -> ras1
ras0[ras0 %in% c(-1, 1)] <- NA
ras1[ras1 <= 0] <- NA
# ras1.nonNA <- not.na(ras1)
# ras1.nonNA.mask <- mask(ras1.nonNA, amaz.basin.shp)
plot(ras0, col=pal(3)[[2]]); plot(amaz.basin.shp$geometry, add=T)
plot(ras1, col=pal(3)[[3]]); plot(amaz.basin.shp$geometry, add=T)
```

## Convert to dataframe

```{r}
DT0 <- terra::as.data.frame(ras0, xy=T)
DT0[, c("x", "y")] <- floor(DT0[, c("x", "y")])
DT1 <- terra::as.data.frame(ras1, xy=T)
DT1[, c("x", "y")] <- floor(DT1[, c("x", "y")])
DT0
DT1
```


24,426,886 + 2,270,498 = 26,697,384

#=====================

# Land Cover data

## Import data

```{r "2.1.Import data"}
# list of files
amaz.landCover.list <- list.files("~/Documents/Amazon_new_data/2. Land Cover/03. Working Data",
                                  full.names=TRUE,
                                  pattern = ".tif$")
# Import data with "Terra"
landCover.rast <- rast(amaz.landCover.list)
landCover.rast
```

## Verification of the data

### Verification the Names of layers

```{r "2.2.names"}
names(landCover.rast) %>% head(24)
```

### Verification of the values

```{r "2.3.Verification of the values"}
# Verification of the values
landCover.minmax <- minmax(landCover.rast) %>% t() %>% as.data.frame()
landCover.minmax
```

### Frequency of each value

```{r "2.4.freq"}
#
tic()
landCover.freq <- freq(landCover.rast, digits=0, usenames=T)
toc() # 385.448 sec elapsed
landCover.freq
# 
landCover.freq[which(!(landCover.freq$value %in% c(0,1,2,3,4,5,6,7,8,9,10)) ),]
```

## Modification of the data

### Rename layers

```{r "2.5.Rename layers"}
# Rename layers
landCover.rast <- renameLayers(landCover.rast, 'landcover_working_', 'lulc_')
# Order layers
ordered.names.2 <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month") %>% 
  format(., '%Y_%m') %>% 
  paste0("lulc_", .)
landCover.rast <- landCover.rast[[ordered.names.2]]
landCover.rast
```

### Create 'rts' object

```{r "2.6.rts"}
# Create a sequence date for 'rts' object
seq.dates <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month")
landCover.rts <- rts(landCover.rast, seq.dates)
landCover.rts
```

## Plot

### Plot all the area

```{r "2.7.plot", warning=FALSE}
# Plot Amazon in the year 2020
plot(landCover.rts[['2020']], col=colorRamps::blue2green(10))

# plot Amazon in October 2020.
plot(landCover.rts[['2020-10-01']], col=colorRamps::blue2green(10), main="Land cover in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
landCover.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=colorRamps::blue2green(10), main="Land cover in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot south of Amazon

```{r "2.8.plot", warning=FALSE}
x_min=-1.25e+06; x_max=0.05e+06; y_min=ymin(burntArea.rast); y_max=2.4e+06

# Plot south of Amazon in the year 2020.
landCover.rts[['2020']]@raster %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=colorRamps::blue2green(10))

# Plot south of Amazon in October 2020.
landCover.rts[['2020-10-01']] %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=colorRamps::blue2green(10), main="Land cover in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

## Verification of the `NA` values

```{r "2.9.na"}
# cl <- makeCluster(detectCores() - 1)
# registerDoParallel(cl, cores=detectCores() - 1)
# 
# tic("landCover")
# #Raster to datatable in parallel: one raster per thread
# rasList <- foreach (ras_id=amaz.landCover.list, .packages=c('terra', 'sf'), .combine='c') %dopar% {
#   #Read all rasters into one big stack
#   ras <- rast(ras_id)
#   # Rename layers
#   ras <- renameLayers(ras, 'landcover_working_', '')
#   #
#   ras.nonNA <- not.na(ras) 
#   ras.nonNA.mask <- mask(ras.nonNA, amaz.basin.shp)
#   ras.freq.na <- freq(ras.nonNA.mask, digits=0, value=0, usenames=T)
#   
#   list(ras.freq.na)
# }
# stopCluster(cl)
# toc()
# 
# #Bind all per-raster into one dataframe
# landCover.freq.na <- rbindlist(rasList, fill=T, use.names=T)
# #
# colnames(landCover.freq.na)[3] <- "landCover_na"
# landCover.freq.na <- landCover.freq.na[order(landCover.freq.na$layer)]
landCover.freq.na
```

#=====================

# Precipitation data

## Import data

```{r "3.1.Import data"}
# list of files
amaz.precipitation.list <- list.files("Amazon_new_data/3. Precipitation/03. Working Data",
                                      full.names=TRUE,
                                      pattern = ".tif$")
# Import data with "Terra"
precipitation.rast <- rast(amaz.precipitation.list)
precipitation.rast
```

## Verification of the data

### Verification the Names of layers

```{r "3.2.names"}
names(precipitation.rast) %>% head()
```

### Verification of the values

```{r "3.3.Verification of the values"}
# Verification of the values
precipitation.minmax <- minmax(precipitation.rast) %>% t() %>% as.data.frame()
precipitation.minmax
```

## Modification of the data

### Rename layers

```{r "3.4.Rename layers"}
# Rename layers
precipitation.rast <- renameLayers(precipitation.rast, 'precipitation_working_', 'prec_')
# Order layers
ordered.names.3 <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month") %>% 
  format(., '%Y_%m') %>% 
  paste0("prec_", .)
precipitation.rast <- precipitation.rast[[ordered.names.3]]
precipitation.rast
```

### Create 'rts' object

```{r "3.5.rts"}
# Create a sequence date for 'rts' object
seq.dates <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month")
precipitation.rts <- rts(precipitation.rast, seq.dates)
precipitation.rts
```

## Plot

### Plot all the area

```{r "3.6.plot", warning=FALSE}
# Plot Amazon in the year 2020
plot(precipitation.rts[['2020']], col=grDevices::cm.colors(1000))

# plot Amazon in October 2020.
plot(precipitation.rts[['2020-10-01']], col=grDevices::cm.colors(1000), main="Precipitation in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
precipitation.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=grDevices::cm.colors(1000), main="Precipitation in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot south of Amazon

```{r "3.7.plot", warning=FALSE}
x_min=-1.25e+06; x_max=0.05e+06; y_min=ymin(burntArea.rast); y_max=2.4e+06

# Plot south of Amazon in the year 2020.
precipitation.rts[['2020']]@raster %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=grDevices::cm.colors(1000))

# Plot south of Amazon in October 2020.
precipitation.rts[['2020-10-01']] %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=grDevices::cm.colors(1000), main="Precipitation in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

## Verification of the `NA` values

```{r "3.8.na"}
# cl <- makeCluster(detectCores() - 1)
# registerDoParallel(cl, cores=detectCores() - 1)
# 
# tic("precipitation")
# #Raster to datatable in parallel: one raster per thread
# rasList <- foreach (ras_id=amaz.precipitation.list, .packages=c('terra', 'sf'), .combine='c') %dopar% {
#   #Read all rasters into one big stack
#   ras <- rast(ras_id)
#   # Rename layers
#   ras <- renameLayers(ras, 'precipitation_working_', '')
#   #
#   ras.nonNA <- not.na(ras) 
#   ras.nonNA.mask <- mask(ras.nonNA, amaz.basin.shp)
#   ras.freq.na <- freq(ras.nonNA.mask, digits=0, value=0, usenames=T)
#   
#   list(ras.freq.na)
# }
# stopCluster(cl)
# toc()
# 
# #Bind all per-raster into one dataframe
# precipitation.freq.na <- rbindlist(rasList, fill=T, use.names=T)
# #
# colnames(precipitation.freq.na)[3] <- "precipitation_na"
# precipitation.freq.na <- precipitation.freq.na[order(precipitation.freq.na$layer)]
precipitation.freq.na
```

## Sample of `NA` values (February 2002)

### Compute

```{r "3.9.na_comp"}
precipitation.2002.02.name <- c("Amazon_new_data/3. Precipitation/03. Working Data/precipitation_working_2002_2.tif")
precipitation.2002.02.rast <- rast(precipitation.2002.02.name)
precipitation.2002.02.rast
#
precipitation.2002.02.nonNA <- not.na(precipitation.2002.02.rast)
precipitation.2002.02.nonNA.mask <- mask(precipitation.2002.02.nonNA, amaz.basin.shp)
#
precipitation.2002.02.nonNA.df <- as.data.frame(precipitation.2002.02.nonNA.mask, xy=T)
precipitation.2002.02.NA.df <- precipitation.2002.02.nonNA.df[precipitation.2002.02.nonNA.df[,3]==F,]
precipitation.2002.02.NA.df
dim(precipitation.2002.02.NA.df)[1]
```

### Plot

```{r "3.10.na_plot"}
# Plot
plot(precipitation.2002.02.rast)
plot(precipitation.2002.02.nonNA.mask, col=c("darkorange1", "forestgreen"))
plot(amaz.basin.shp$geometry, add=T)
#
x_min=-0.45e+06; x_max=-0.3e+06; y_min=ymin(precipitation.2002.02.nonNA.mask); y_max=1.71e+06
precipitation.2002.02.nonNA.mask %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  plot(col=c("darkorange1", "forestgreen"))
```

#=====================

# Soil Moisture data

## Import data

```{r "4.1.Import data"}
# list of files
amaz.soilMoisture.list <- list.files("Amazon_new_data/4. Soil Moisture/03. Working Data",
                                     full.names=TRUE,
                                     pattern = ".tif$")
# Import data with "Terra"
soilMoisture.rast <- rast(amaz.soilMoisture.list)
soilMoisture.rast
```

## Verification of the data

### Verification the Names of layers

```{r "4.2.names"}
names(soilMoisture.rast) %>% head()
```

### Verification of the values

```{r "4.3.Verification of the values"}
# Verification of the values
soilMoisture.minmax <- minmax(soilMoisture.rast) %>% t() %>% as.data.frame()
soilMoisture.minmax
```

### Frequency

```{r "4.4.freq"}
# soilMoisture.freq <- freq(soilMoisture.rast, digits=3, usenames=T)
soilMoisture.freq
#
soilMoisture.freq[soilMoisture.freq$value < 0,]
```

## Modification of the data

### Rename layers

```{r "4.5.Rename layers"}
# Rename layers
soilMoisture.rast <- renameLayers(soilMoisture.rast, 'soilmoisture_working_', 'soilm_')
# Order layers
ordered.names.4 <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month") %>% 
  format(., '%Y_%m') %>% 
  paste0("soilm_", .)
soilMoisture.rast <- soilMoisture.rast[[ordered.names.4]]
# Print
soilMoisture.rast
cat('\n---------- \n\n')
names(soilMoisture.rast) %>% head()
```

### Create 'rts' object

```{r "4.6.rts"}
# Create a sequence date for 'rts' object
seq.dates <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month")
soilMoisture.rts <- rts(soilMoisture.rast, seq.dates)
soilMoisture.rts
```

## Plot

### Plot all the area

```{r "4.7.plot", warning=FALSE}
# Plot Amazon in the year 2020
plot(soilMoisture.rts[['2020']], col=colorRamps::matlab.like2(1000))

# plot Amazon in October 2020.
plot(soilMoisture.rts[['2020-10-01']], col=colorRamps::matlab.like2(1000), main="Soil Moisture in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
soilMoisture.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=colorRamps::matlab.like2(1000), main="Soil Moisture in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
x_min=0.1e+06; x_max=0.5e+06; y_min=4.25e+06; y_max=ymax(burntArea.rast)
soilMoisture.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  plot(col=colorRamps::matlab.like2(1000), main="Soil Moisture in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Repalce negative values by `NA` for 2020

```{r "4.8.na"}
soilMoisture.2020.rts <- soilMoisture.rts[['2020']]
# Remove negative values.
soilMoisture.2020.rts@raster[soilMoisture.2020.rts@raster < 0] <- NA
soilMoisture.2020.rts
```


### Plot all the area

```{r "4.9.plot", warning=FALSE}
# Plot Amazon in the year 2020
plot(soilMoisture.2020.rts, col=colorRamps::matlab.like2(1000))

# plot Amazon in October 2020.
plot(soilMoisture.2020.rts[['2020-10-01']], col=colorRamps::matlab.like2(1000), main="Soil Moisture in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
soilMoisture.2020.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=colorRamps::matlab.like2(1000), main="Soil Moisture in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot south of Amazon

```{r "4.10.plot", warning=FALSE}
x_min=-1.25e+06; x_max=0.05e+06; y_min=ymin(burntArea.rast); y_max=2.4e+06

# Plot south of Amazon in the year 2020.
soilMoisture.2020.rts@raster %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=colorRamps::matlab.like2(1000))

# Plot south of Amazon in October 2020.
soilMoisture.2020.rts[['2020-10-01']] %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=colorRamps::matlab.like2(1000), main="Soil Moisture in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

## Repalce negative values by `NA` for all data

```{r "4.11.na"}
# # Remove negative values.
# soilMoisture.rast[soilMoisture.rast < 0] <- NA
# # Save raster file
# writeRaster(soilMoisture.rast, "Amazon_new_data/4. Soil Moisture/soilmoisture_working_na.tif", overwrite=TRUE)

# Load data
soilMoisture.na.rast <- rast("Amazon_new_data/4. Soil Moisture/soilmoisture_working_na.tif")
soilMoisture.na.rast
```

## Verification of the `NA` values

```{r "4.12.na"}
# cl <- makeCluster(detectCores() - 1)
# registerDoParallel(cl, cores=detectCores() - 1)
# 
# tic("soilmoisture")
# #Raster to datatable in parallel: one raster per thread
# rasList <- foreach (ras_id=amaz.soilMoisture.list, .packages=c('terra', 'sf'), .combine='c') %dopar% {
#   #Read all rasters into one big stack
#   ras <- rast(ras_id)
#   # Rename layers
#   ras <- renameLayers(ras, 'soilmoisture_working_', '')
#   # Replace negative value by `NA`
#   ras[ras < 0] <- NA
#   #
#   ras.nonNA <- not.na(ras) 
#   ras.nonNA.mask <- mask(ras.nonNA, amaz.basin.shp)
#   ras.freq.na <- freq(ras.nonNA.mask, digits=0, value=0, usenames=T)
#   
#   list(ras.freq.na)
# }
# stopCluster(cl)
# toc()
# 
# #Bind all per-raster into one dataframe
# soilmoisture.freq.na <- rbindlist(rasList, fill=T, use.names=T)
# #
# colnames(soilmoisture.freq.na)[3] <- "soilmoisture_na"
# soilmoisture.freq.na <- soilmoisture.freq.na[order(soilmoisture.freq.na$layer)]
soilmoisture.freq.na
```

## Sample of `NA` values (February 2002)

### Compute

```{r "4.13.na_comp"}
soilmoisture.2002.02.name <- c("Amazon_new_data/4. Soil Moisture/03. Working Data/soilmoisture_working_2002_2.tif")
soilmoisture.2002.02.rast <- rast(soilmoisture.2002.02.name)
# Repalce negative values by `NA` for all data
soilmoisture.2002.02.rast[soilmoisture.2002.02.rast < 0] <- NA
soilmoisture.2002.02.rast
#
soilmoisture.2002.02.nonNA <- not.na(soilmoisture.2002.02.rast)
soilmoisture.2002.02.nonNA.mask <- mask(soilmoisture.2002.02.nonNA, amaz.basin.shp)
#
soilmoisture.2002.02.nonNA.df <- as.data.frame(soilmoisture.2002.02.nonNA.mask, xy=T)
soilmoisture.2002.02.NA.df <- soilmoisture.2002.02.nonNA.df[soilmoisture.2002.02.nonNA.df[,3]==F,]
soilmoisture.2002.02.NA.df
dim(soilmoisture.2002.02.NA.df)[1]
```

### Plot

```{r "4.14.na_plot"}
# Plot
plot(soilmoisture.2002.02.nonNA.mask, col=c("darkorange1", "forestgreen"))
#
x_min=-0.45e+06; x_max=-0.3e+06; y_min=ymin(soilmoisture.2002.02.nonNA.mask); y_max=1.71e+06
soilmoisture.2002.02.nonNA.mask %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  plot(col=c("darkorange1", "forestgreen"))
#
x_min=1.2e+06; x_max=2.5e+06; y_min=3e+06; y_max=3.5e+06
soilmoisture.2002.02.nonNA.mask %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  plot(col=c("darkorange1", "forestgreen"))
#
x_min=0.1e+06; x_max=0.5e+06; y_min=4.25e+06; y_max=ymax(soilmoisture.2002.02.nonNA.mask)
soilmoisture.2002.02.nonNA.mask %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  plot(col=c("darkorange1", "forestgreen"))
```

#=====================

# Elevation data

## Import data

```{r "5.1.Import data"}
# list of files
amaz.elevation.list <- list.files("Amazon_new_data/5. Elevation/03. Working Data",
                                  full.names=TRUE,
                                  pattern = ".tif$")
# Import data with "Terra"
elevation.rast <- rast(amaz.elevation.list)
elevation.rast
```

## Verification of the data

### Verification the Names of layers

```{r "5.2.names"}
names(elevation.rast)
```

### Verification of the values

```{r "5.3.Verification of the values"}
# Verification of the values
elevation.minmax <- minmax(elevation.rast) %>% t() %>% as.data.frame()
elevation.minmax
```

## Modification of the data

### Rename layers

```{r "5.4.Rename layers"}
names(elevation.rast) <- "elevation"
elevation.rast
```

### Create 'rts' object

```{r "5.5.rts"}
# Create a sequence date for 'rts' object
seq.dates <- seq(as.Date("2020-12-1"), as.Date("2020-12-1"), by = "month")
elevation.rts <- rts(elevation.rast, seq.dates)
elevation.rts
```

## Plot

### Plot all the area

```{r "5.6.plot", warning=FALSE}
# plot.
plot(elevation.rts[['2020-12-01']], col=colorRamps::matlab.like(1000), main="Elevation")
plot(amaz.basin.shp$geometry, add=T)
#
elevation.rts[['2020-12-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=colorRamps::matlab.like(1000), main="Elevation")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot south of Amazon

```{r "5.7.plot", warning=FALSE}
x_min=-1.25e+06; x_max=0.05e+06; y_min=ymin(burntArea.rast); y_max=2.4e+06

# Plot south of Amazon.
elevation.rts[['2020-12-01']] %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=colorRamps::matlab.like(1000), main="Elevation")
plot(amaz.basin.shp$geometry, add=T)
```

## Verification of the `NA` values

```{r "5.8.na"}
# cl <- makeCluster(detectCores() - 1)
# registerDoParallel(cl, cores=detectCores() - 1)
# 
# tic("elevation")
# #Raster to datatable in parallel: one raster per thread
# rasList <- foreach (ras_id=amaz.elevation.list, .packages=c('terra', 'sf'), .combine='c') %dopar% {
#   #Read all rasters into one big stack
#   ras <- rast(ras_id)
#   # Rename layers
#   names(ras) <- "2020_12"
#   #
#   ras.nonNA <- not.na(ras) 
#   ras.nonNA.mask <- mask(ras.nonNA, amaz.basin.shp)
#   ras.freq.na <- freq(ras.nonNA.mask, digits=0, value=0, usenames=T)
#   
#   list(ras.freq.na)
# }
# stopCluster(cl)
# toc()
# 
# #Bind all per-raster into one dataframe
# elevation.freq.na <- rbindlist(rasList, fill=T, use.names=T)
# #
# colnames(elevation.freq.na)[3] <- "elevation_na"
# elevation.freq.na <- elevation.freq.na[order(elevation.freq.na$layer)]
elevation.freq.na
```

#=====================

# LandSurfaceTemp data

## Import data

```{r "6.1.Import data"}
# list of files
amaz.landSurfaceTemp.list <- list.files("Amazon_new_data/6. LandSurfaceTemp/03. Working Data",
                                     full.names=TRUE,
                                     pattern = ".tif$")
# Import data with "Terra"
landSurfaceTemp.rast <- rast(amaz.landSurfaceTemp.list)
landSurfaceTemp.rast
```

## Verification of the data

### Verification the Names of layers

```{r "6.2.names"}
names(landSurfaceTemp.rast) %>% head()
```

### Verification of the values

```{r "6.3.Verification of the values"}
# Verification of the values
landSurfaceTemp.minmax <- minmax(landSurfaceTemp.rast) %>% t() %>% as.data.frame()
landSurfaceTemp.minmax
```

## Modification of the data

### Rename layers

```{r "6.4.Rename layers"}
landSurfaceTemp.rast <- renameLayers(landSurfaceTemp.rast, 'landsurftemp_working_', 'landsurftemp_')
# Order layers
ordered.names.6 <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month") %>% 
  format(., '%Y_%m') %>% 
  paste0("landsurftemp_", .)
landSurfaceTemp.rast <- landSurfaceTemp.rast[[ordered.names.6]]
# Print
landSurfaceTemp.rast
cat('\n---------- \n\n')
names(landSurfaceTemp.rast) %>% head()
```

### Create 'rts' object

```{r "6.5.rts"}
# Create a sequence date for 'rts' object
seq.dates <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month")
landSurfaceTemp.rts <- rts(landSurfaceTemp.rast, seq.dates)
landSurfaceTemp.rts
```

## Plot

### Plot all the area

```{r "6.6.plot", warning=FALSE}
# Plot Amazon in the year 2020
plot(landSurfaceTemp.rts[['2020']], col=colorRamps::green2red(1000))

# plot Amazon in October 2020.
plot(landSurfaceTemp.rts[['2020-10-01']], col=colorRamps::green2red(1000), main="Land Surface Temp in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
landSurfaceTemp.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=colorRamps::green2red(1000), main="Land Surface Temp in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot south of Amazon

```{r "6.7.plot", warning=FALSE}
x_min=-1.25e+06; x_max=0.05e+06; y_min=ymin(burntArea.rast); y_max=2.4e+06

# Plot south of Amazon in the year 2020.
landSurfaceTemp.rts[['2020']]@raster %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=colorRamps::green2red(1000))

# Plot south of Amazon in October 2020.
landSurfaceTemp.rts[['2020-10-01']] %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=colorRamps::green2red(1000), main="Land Surface Temp in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

## Verification of the `NA` values

```{r "6.8.plot"}
# cl <- makeCluster(detectCores() - 1)
# registerDoParallel(cl, cores=detectCores() - 1)
# 
# tic("landsurftemp")
# #Raster to datatable in parallel: one raster per thread
# rasList <- foreach (ras_id=amaz.landSurfaceTemp.list, .packages=c('terra', 'sf'), .combine='c') %dopar% {
#   #Read all rasters into one big stack
#   ras <- rast(ras_id)
#   # Rename layers
#   ras <- renameLayers(ras, 'landsurftemp_working_', '')
#   #
#   ras.nonNA <- not.na(ras) 
#   ras.nonNA.mask <- mask(ras.nonNA, amaz.basin.shp)
#   ras.freq.na <- freq(ras.nonNA.mask, digits=0, value=0, usenames=T)
#   
#   list(ras.freq.na)
# }
# stopCluster(cl)
# toc()
# 
# #Bind all per-raster into one dataframe
# landsurftemp.freq.na <- rbindlist(rasList, fill=T, use.names=T)
# #
# colnames(landsurftemp.freq.na)[3] <- "landsurftemp_na"
# landsurftemp.freq.na <- landsurftemp.freq.na[order(landsurftemp.freq.na$layer)]
landsurftemp.freq.na
```

## Sample of `NA` values (February 2002)

### Compute

```{r "6.10.na_comp"}
landSurfaceTemp.2002.02.name <- c("Amazon_new_data/6. LandSurfaceTemp/03. Working Data/landsurftemp_working_2002_2.tif")
landSurfaceTemp.2002.02.rast <- rast(landSurfaceTemp.2002.02.name)
landSurfaceTemp.2002.02.rast
#
landSurfaceTemp.2002.02.nonNA <- not.na(landSurfaceTemp.2002.02.rast)
landSurfaceTemp.2002.02.nonNA.mask <- mask(landSurfaceTemp.2002.02.nonNA, amaz.basin.shp)
#
landSurfaceTemp.2002.02.nonNA.df <- as.data.frame(landSurfaceTemp.2002.02.nonNA.mask, xy=T)
landSurfaceTemp.2002.02.NA.df <- landSurfaceTemp.2002.02.nonNA.df[landSurfaceTemp.2002.02.nonNA.df[,3]==F,]
landSurfaceTemp.2002.02.NA.df
dim(landSurfaceTemp.2002.02.NA.df)[1]
```

### Plot

```{r "6.11.na_plot"}
# Plot
plot(landSurfaceTemp.2002.02.rast)
plot(landSurfaceTemp.2002.02.nonNA.mask, col=c("darkorange1", "forestgreen"))
plot(amaz.basin.shp$geometry, add=T)
```

#=====================

# Specific Humidity data

## Import data

```{r "7.1.Import data"}
# list of files
amaz.humidity.list <- list.files("Amazon_new_data/7. Specific Humidity/03. Working Data",
                                 full.names=TRUE,
                                 pattern = ".tif$")
# Import data with "Terra"
humidity.rast <- rast(amaz.humidity.list)
humidity.rast
```

## Verification of the data

### Verification the Names of layers

```{r "7.2.names"}
names(humidity.rast) %>% head()
```

### Verification of the values

```{r "7.3.Verification of the values"}
# Verification of the values
humidity.minmax <- minmax(humidity.rast) %>% t() %>% as.data.frame()
humidity.minmax
```

## Modification of the data

### Rename layers

```{r "7.4.Rename layers"}
humidity.rast <- renameLayers(humidity.rast, 'humidity_working_', 'humidity_')
# Order layers
ordered.names.7 <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month") %>% 
  format(., '%Y_%m') %>% 
  paste0("humidity_", .)
humidity.rast <- humidity.rast[[ordered.names.7]]
# Print
humidity.rast
cat('\n---------- \n\n')
names(humidity.rast) %>% head()
```

### Create 'rts' object

```{r "7.5.rts"}
# Create a sequence date for 'rts' object
seq.dates <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month")
humidity.rts <- rts(humidity.rast, seq.dates)
humidity.rts
```

## Plot

### Plot all the area

```{r "7.6.plot", warning=FALSE}
# Plot Amazon in the year 2020
plot(humidity.rts[['2020']], col=topo.colors(20))

# plot Amazon in October 2020.
plot(humidity.rts[['2020-10-01']], col=topo.colors(20), main="Humidity in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
humidity.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=topo.colors(20), main="Humidity in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot south of Amazon

```{r "7.7.plot", warning=FALSE}
x_min=-1.25e+06; x_max=0.05e+06; y_min=ymin(burntArea.rast); y_max=2.4e+06

# Plot south of Amazon in the year 2020.
humidity.rts[['2020']]@raster %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=topo.colors(20))

# Plot south of Amazon in October 2020.
humidity.rts[['2020-10-01']] %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=topo.colors(20), main="Humidity in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

## Verification of the `NA` values

```{r "7.8.na"}
# cl <- makeCluster(detectCores() - 1)
# registerDoParallel(cl, cores=detectCores() - 1)
# 
# tic("humidity")
# #Raster to datatable in parallel: one raster per thread
# rasList <- foreach (ras_id=amaz.humidity.list, .packages=c('terra', 'sf'), .combine='c') %dopar% {
#   #Read all rasters into one big stack
#   ras <- rast(ras_id)
#   # Rename layers
#   ras <- renameLayers(ras, 'humidity_working_', '')
#   #
#   ras.nonNA <- not.na(ras) 
#   ras.nonNA.mask <- mask(ras.nonNA, amaz.basin.shp)
#   ras.freq.na <- freq(ras.nonNA.mask, digits=0, value=0, usenames=T)
#   
#   list(ras.freq.na)
# }
# stopCluster(cl)
# toc()
# 
# #Bind all per-raster into one dataframe
# humidity.freq.na <- rbindlist(rasList, fill=T, use.names=T)
# #
# colnames(humidity.freq.na)[3] <- "humidity_na"
# humidity.freq.na <- humidity.freq.na[order(humidity.freq.na$layer)]
humidity.freq.na
```

## Sample of `NA` values (February 2002)

### Compute

```{r "7.9.na_comp"}
humidity.2002.02.name <- c("Amazon_new_data/7. Specific Humidity/03. Working Data/humidity_working_2002_2.tif")
humidity.2002.02.rast <- rast(humidity.2002.02.name)
humidity.2002.02.rast
#
humidity.2002.02.nonNA <- not.na(humidity.2002.02.rast)
humidity.2002.02.nonNA.mask <- mask(humidity.2002.02.nonNA, amaz.basin.shp)
#
humidity.2002.02.nonNA.df <- as.data.frame(humidity.2002.02.nonNA.mask, xy=T)
humidity.2002.02.NA.df <- humidity.2002.02.nonNA.df[humidity.2002.02.nonNA.df[,3]==F,]
humidity.2002.02.NA.df
dim(humidity.2002.02.NA.df)[1]
```

### Plot

```{r "7.10.na_plot"}
# Plot
plot(humidity.2002.02.nonNA.mask, col=c("darkorange1", "forestgreen"))
#
x_min=-0.45e+06; x_max=-0.3e+06; y_min=ymin(humidity.2002.02.nonNA.mask); y_max=1.71e+06
humidity.2002.02.nonNA.mask %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  plot(col=c("darkorange1", "forestgreen"))
#
x_min=0.e+06; x_max=xmax(humidity.2002.02.nonNA.mask); y_min=3.e+06; y_max=ymax(humidity.2002.02.nonNA.mask)
humidity.2002.02.nonNA.mask %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  plot(col=c("darkorange1", "forestgreen"))
```

#=====================

# Evapotranspiration data

## Import data

```{r "8.1.Import data"}
# list of files
amaz.evapotranspiration.list <- list.files("Amazon_new_data/8. Evapotranspiration/03. Working Data",
                                           full.names=TRUE,
                                           pattern = ".tif$")
# Import data with "Terra"
evapotranspiration.rast <- rast(amaz.evapotranspiration.list)
evapotranspiration.rast
```

## Verification of the data

### Verification the Names of layers

```{r "8.2.names"}
names(evapotranspiration.rast) %>% head()
```

### Verification of the values

```{r "8.3.Verification of the values"}
# Verification of the values
evapotranspiration.minmax <- minmax(evapotranspiration.rast) %>% t() %>% as.data.frame()
evapotranspiration.minmax
```

## Modification of the data

### Rename layers

```{r "8.4.Rename layers"}
evapotranspiration.rast <- renameLayers(evapotranspiration.rast, 'evapotranspiration_working_', 'evapotranspiration_')
# Order layers
ordered.names.8 <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month") %>% 
  format(., '%Y_%m') %>% 
  paste0("evapotranspiration_", .)
evapotranspiration.rast <- evapotranspiration.rast[[ordered.names.8]]
# Print
evapotranspiration.rast
cat('\n---------- \n\n')
names(evapotranspiration.rast) %>% head()
```

### Create 'rts' object

```{r "8.5.rts"}
# Create a sequence date for 'rts' object
seq.dates <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month")
evapotranspiration.rts <- rts(evapotranspiration.rast, seq.dates)
evapotranspiration.rts
```

## Plot

### Plot all the area

```{r "8.6.plot", warning=FALSE}
nbr_colors <- colorRampPalette(brewer.pal(9, "YlOrBr"))
# Plot Amazon in the year 2020
plot(evapotranspiration.rts[['2020']], col=nbr_colors(100))

# plot Amazon in October 2020.
plot(evapotranspiration.rts[['2020-10-01']], col=nbr_colors(100), main="Evapotranspiration in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
evapotranspiration.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=nbr_colors(100), main="Evapotranspiration in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot south of Amazon

```{r "8.7.plot", warning=FALSE}
nbr_colors <- colorRampPalette(brewer.pal(9, "YlOrBr"))
x_min=-1.25e+06; x_max=0.05e+06; y_min=ymin(burntArea.rast); y_max=2.4e+06

# Plot south of Amazon in the year 2020.
evapotranspiration.rts[['2020']]@raster %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=nbr_colors(100))

# Plot south of Amazon in October 2020.
evapotranspiration.rts[['2020-10-01']] %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=nbr_colors(100), main="Evapotranspiration in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

## Verification of the `NA` values

```{r "8.8.na"}
# cl <- makeCluster(detectCores() - 1)
# registerDoParallel(cl, cores=detectCores() - 1)
# 
# tic("evapotranspiration")
# #Raster to datatable in parallel: one raster per thread
# rasList <- foreach (ras_id=amaz.evapotranspiration.list, .packages=c('terra', 'sf'), .combine='c') %dopar% {
#   #Read all rasters into one big stack
#   ras <- rast(ras_id)
#   # Rename layers
#   ras <- renameLayers(ras, 'evapotranspiration_working_', '')
#   #
#   ras.nonNA <- not.na(ras) 
#   ras.nonNA.mask <- mask(ras.nonNA, amaz.basin.shp)
#   ras.freq.na <- freq(ras.nonNA.mask, digits=0, value=0, usenames=T)
#   
#   list(ras.freq.na)
# }
# stopCluster(cl)
# toc()
# 
# #Bind all per-raster into one dataframe
# evapotranspiration.freq.na <- rbindlist(rasList, fill=T, use.names=T)
# #
# colnames(evapotranspiration.freq.na)[3] <- "evapotranspiration_na"
# evapotranspiration.freq.na <- evapotranspiration.freq.na[order(evapotranspiration.freq.na$layer)]
evapotranspiration.freq.na
```

## Sample of `NA` values (February 2002)

### Compute

```{r "8.9.na_comp"}

evapotranspi.2002.02.name <- c("Amazon_new_data/8. Evapotranspiration/03. Working Data/evapotranspiration_working_2002_2.tif")
evapotranspi.2002.02.rast <- rast(evapotranspi.2002.02.name)
evapotranspi.2002.02.rast
#
evapotranspi.2002.02.nonNA <- not.na(evapotranspi.2002.02.rast)
evapotranspi.2002.02.nonNA.mask <- mask(evapotranspi.2002.02.nonNA, amaz.basin.shp)
#
evapotranspi.2002.02.nonNA.df <- as.data.frame(evapotranspi.2002.02.nonNA.mask, xy=T)
evapotranspi.2002.02.NA.df <- evapotranspi.2002.02.nonNA.df[evapotranspi.2002.02.nonNA.df[,3]==F,]
evapotranspi.2002.02.NA.df
dim(evapotranspi.2002.02.NA.df)[1]
```

### Plot

```{r "8.10.na_plot"}
# Plot
plot(evapotranspi.2002.02.nonNA.mask, col=c("darkorange1", "forestgreen"))
```

#=====================

# Wind Speed data

## Import data

```{r "9.1.Import data"}
# list of files
amaz.wind.list <- list.files("Amazon_new_data/9. Wind Speed/03. Working Data",
                             full.names=TRUE,
                             pattern = ".tif$")
# Import data with "Terra"
wind.rast <- rast(amaz.wind.list)
wind.rast
```

## Verification of the data

### Verification the Names of layers

```{r "9.2.names"}
names(wind.rast) %>% head()
```

### Verification of the values

```{r "9.3.Verification of the values"}
# Verification of the values
wind.minmax <- minmax(wind.rast) %>% t() %>% as.data.frame()
wind.minmax
```

## Modification of the data

### Rename layers

```{r "9.4.Rename layers"}
wind.rast <- renameLayers(wind.rast, 'wind_working_', 'wind_')
# Order layers
ordered.names.9 <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month") %>% 
  format(., '%Y_%m') %>% 
  paste0("wind_", .)
wind.rast <- wind.rast[[ordered.names.9]]
# Print
wind.rast
cat('\n---------- \n\n')
names(wind.rast) %>% head()
```

### Create 'rts' object

```{r "9.5.rts"}
# Create a sequence date for 'rts' object
seq.dates <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month")
wind.rts <- rts(wind.rast, seq.dates)
wind.rts
```

## Plot

### Plot all the area

```{r "9.6.plot", warning=FALSE}
# Plot Amazon in the year 2020
plot(wind.rts[['2020']], col=cm.colors(50))

# plot Amazon in October 2020.
plot(wind.rts[['2020-10-01']], col=cm.colors(50), main="Wind in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
wind.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=cm.colors(50), main="Wind in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot south of Amazon

```{r "9.7.plot", warning=FALSE}
x_min=-1.25e+06; x_max=0.05e+06; y_min=ymin(burntArea.rast); y_max=2.4e+06

# Plot south of Amazon in the year 2020.
wind.rts[['2020']]@raster %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=cm.colors(50))

# Plot south of Amazon in October 2020.
wind.rts[['2020-10-01']] %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=cm.colors(50), main="Wind in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

## Verification of the `NA` values

```{r "9.8.na"}
# cl <- makeCluster(detectCores() - 1)
# registerDoParallel(cl, cores=detectCores() - 1)
# 
# tic("wind")
# #Raster to datatable in parallel: one raster per thread
# rasList <- foreach (ras_id=amaz.wind.list, .packages=c('terra', 'sf'), .combine='c') %dopar% {
#   #Read all rasters into one big stack
#   ras <- rast(ras_id)
#   # Rename layers
#   ras <- renameLayers(ras, 'wind_working_', '')
#   #
#   ras.nonNA <- not.na(ras) 
#   ras.nonNA.mask <- mask(ras.nonNA, amaz.basin.shp)
#   ras.freq.na <- freq(ras.nonNA.mask, digits=0, value=0, usenames=T)
#   
#   list(ras.freq.na)
# }
# stopCluster(cl)
# toc()
# 
# #Bind all per-raster into one dataframe
# wind.freq.na <- rbindlist(rasList, fill=T, use.names=T)
# #
# colnames(wind.freq.na)[3] <- "wind_na"
# wind.freq.na <- wind.freq.na[order(wind.freq.na$layer)]
wind.freq.na
```

## Sample of `NA` values (February 2002)

### Compute

```{r "9.9.na_comp"}
wind.2002.02.name <- c("Amazon_new_data/9. Wind Speed/03. Working Data/wind_working_2002_2.tif")
wind.2002.02.rast <- rast(wind.2002.02.name)
wind.2002.02.rast
#
wind.2002.02.nonNA <- not.na(wind.2002.02.rast)
wind.2002.02.nonNA.mask <- mask(wind.2002.02.nonNA, amaz.basin.shp)
#
wind.2002.02.nonNA.df <- as.data.frame(wind.2002.02.nonNA.mask, xy=T)
wind.2002.02.NA.df <- wind.2002.02.nonNA.df[wind.2002.02.nonNA.df[,3]==F,]
wind.2002.02.NA.df
dim(wind.2002.02.NA.df)[1]
```

### Plot

```{r "9.10.na_plot"}
# Plot
plot(wind.2002.02.nonNA.mask, col=c("darkorange1", "forestgreen"))
#
x_min=0.e+06; x_max=xmax(wind.2002.02.nonNA.mask); y_min=3.e+06; y_max=ymax(wind.2002.02.nonNA.mask)
wind.2002.02.nonNA.mask %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  plot(col=c("darkorange1", "forestgreen"))
```

#=====================

# Air Temperature data

## Import data

```{r "10.1.Import data"}
# list of files
amaz.airtemp.list <- list.files("Amazon_new_data/10. Air Temperature/03. Working Data",
                                full.names=TRUE,
                                pattern = ".tif$")
# Import data with "Terra"
airtemp.rast <- rast(amaz.airtemp.list)
airtemp.rast
```

## Verification of the data

### Verification the Names of layers

```{r "10.2.names"}
names(airtemp.rast) %>% head()
```

### Verification of the values

```{r "10.3.Verification of the values"}
# Verification of the values
airtemp.minmax <- minmax(airtemp.rast) %>% t() %>% as.data.frame()
airtemp.minmax
```

## Modification of the data

### Rename layers

```{r "10.4.Rename layers"}
airtemp.rast <- renameLayers(airtemp.rast, 'airtemp_working_', 'airtemp_')
# Order layers
ordered.names.10 <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month") %>% 
  format(., '%Y_%m') %>% 
  paste0("airtemp_", .)
airtemp.rast <- airtemp.rast[[ordered.names.10]]
# Print
airtemp.rast
cat('\n---------- \n\n')
names(airtemp.rast) %>% head()
```

### Create 'rts' object

```{r "10.5.rts"}
# Create a sequence date for 'rts' object
seq.dates <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month")
airtemp.rts <- rts(airtemp.rast, seq.dates)
airtemp.rts
```

## Plot

### Plot all the area

```{r "10.6.plot", warning=FALSE}
# Plot Amazon in the year 2020
plot(airtemp.rts[['2020']], col=colorRamps::matlab.like(100))

# plot Amazon in October 2020.
plot(airtemp.rts[['2020-10-01']], col=colorRamps::matlab.like(100), main="Air Temp. in October 2020")
plot(amaz.basin.shp$geometry, add=T)
#
airtemp.rts[['2020-10-01']] %>% 
  mask(mask = amaz.basin.shp) %>% 
  plot(col=colorRamps::matlab.like(100), main="Air Temp. in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

### Plot south of Amazon

```{r "10.7.plot", warning=FALSE}
x_min=-1.25e+06; x_max=0.05e+06; y_min=ymin(burntArea.rast); y_max=2.4e+06

# Plot south of Amazon in the year 2020.
airtemp.rts[['2020']]@raster %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=colorRamps::matlab.like(100))

# Plot south of Amazon in October 2020.
airtemp.rts[['2020-10-01']] %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  mask(mask = amaz.basin.shp) %>%
  plot(col=colorRamps::matlab.like(100), main="Air Temp. in October 2020")
plot(amaz.basin.shp$geometry, add=T)
```

## Verification of the `NA` values

```{r "10.8.na"}
# cl <- makeCluster(detectCores() - 1)
# registerDoParallel(cl, cores=detectCores() - 1)
# 
# tic("airtemp")
# #Raster to datatable in parallel: one raster per thread
# rasList <- foreach (ras_id=amaz.airtemp.list, .packages=c('terra', 'sf'), .combine='c') %dopar% {
#   #Read all rasters into one big stack
#   ras <- rast(ras_id)
#   # Rename layers
#   ras <- renameLayers(ras, 'airtemp_working_', '')
#   #
#   ras.nonNA <- not.na(ras) 
#   ras.nonNA.mask <- mask(ras.nonNA, amaz.basin.shp)
#   ras.freq.na <- freq(ras.nonNA.mask, digits=0, value=0, usenames=T)
#   
#   list(ras.freq.na)
# }
# stopCluster(cl)
# toc()
# 
# #Bind all per-raster into one dataframe
# airtemp.freq.na <- rbindlist(rasList, fill=T, use.names=T)
# #
# colnames(airtemp.freq.na)[3] <- "airtemp_na"
# airtemp.freq.na <- airtemp.freq.na[order(airtemp.freq.na$layer)]
airtemp.freq.na
```


## Sample of `NA` values (February 2002)

### Compute

```{r "10.9.na_comp"}
airtemp.2002.02.name <- c("Amazon_new_data/10. Air Temperature/03. Working Data/airtemp_working_2002_2.tif")
airtemp.2002.02.rast <- rast(airtemp.2002.02.name)
airtemp.2002.02.rast
#
airtemp.2002.02.nonNA <- not.na(airtemp.2002.02.rast)
airtemp.2002.02.nonNA.mask <- mask(airtemp.2002.02.nonNA, amaz.basin.shp)
#
airtemp.2002.02.nonNA.df <- as.data.frame(airtemp.2002.02.nonNA.mask, xy=T)
airtemp.2002.02.NA.df <- airtemp.2002.02.nonNA.df[airtemp.2002.02.nonNA.df[,3]==F,]
airtemp.2002.02.NA.df
dim(airtemp.2002.02.NA.df)[1]
```

### Plot

```{r "10.10.na_plot"}
# Plot
plot(airtemp.2002.02.nonNA.mask, col=c("darkorange1", "forestgreen"))
#
x_min=0.e+06; x_max=xmax(airtemp.2002.02.nonNA.mask); y_min=3.e+06; y_max=ymax(airtemp.2002.02.nonNA.mask)
airtemp.2002.02.nonNA.mask %>% 
  crop(ext(x_min, x_max, y_min, y_max)) %>% 
  plot(col=c("darkorange1", "forestgreen"))
```

#=====================

# Merge all dataframes of `NA` values.

```{r "11.1.merge"}
# create the dataframe
seq.dates.str <- seq(as.Date("2001-1-1"), as.Date("2020-12-1"), by = "month") %>% format("%Y_%m")
amaz.na.df <- as.data.frame(seq.dates.str)
colnames(amaz.na.df) <- "layer"
# Merge
amaz.na.df <- list(amaz.na.df, 
                   burntArea.freq.na[,-2], 
                   landCover.freq.na[,-2], 
                   precipitation.freq.na[,-2],
                   soilmoisture.freq.na[,-2],
                   elevation.freq.na[,-2],
                   landsurftemp.freq.na[,-2], 
                   humidity.freq.na[,-2], 
                   evapotranspiration.freq.na[,-2],
                   wind.freq.na[,-2], 
                   airtemp.freq.na[,-2]) %>% 
  reduce(full_join, by="layer")

amaz.na.df
```

```{r "11.2.year2012"}
amaz.na.df[133:144,]
```

#=====================


































